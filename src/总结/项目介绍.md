# 项目介绍

一、背景：
在抢购等场景下，服务会收到很大的流量请求。此时如果这些流量完全交由业务服务从数据库查询再去响应，具有两大弊端：

1. 数据库连接过多导致崩溃
2. 响应迟缓，影响用户体验

因此打算采用缓存的思路来应对大流量场景。
缓存之处有两个，

一个是对页面的静态资源(static，HTML,CSS等)进行缓存，这样可以减轻主服务的压力。动态信息可以通过Ajax获取。
另一个是对数据库中部分数据进行缓存，减轻数据库压力，并且可以提高操作数据库的速度。

方案：

1. 使用Nginx进行反向代理与缓存静态资源
2. 在数据库侧添加Redis，用于支持动态数据的获取

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL1NraXJvbllvbmcvc2tpcm9uSW1ncy9pbWcvMjAyMDA2MTYxNTIyMjgucG5n?x-oss-process=image/format,png)



二、分布式拓展

1、Nginx反向代理负载均衡

​	Nginx作用

- 可以做静态web服务器
- 可以做为动静分离服务器，将静态资源的请求直接处理，将动态的请求转发给相应后端服务，并以ajax的形式返回给前端
- 做反向代理服务器

使用Nginx作为反向代理服务器将后台服务器进行水平扩展，使用统一的域名进行访问，采用负载轮询的方式，Nginx由于其采用了epoll多路复用和协程机制保证了其高可用。

Nginx协程机制

- Nginx每个工作进程创建一个lua虚拟机。用来跑lua文件

- 工作进程内的所有协程共享同一个vm

- 每一个外部请求由一个lua协程处理，之间数据隔离

- lua代码调用io等异步接口时，协程被挂起，上下文数据保持不变

- 自动保存，不阻塞工作进程

- io异步操作完成后还原协程上下文，代码继续执行。即代码是同步型的编程，比较简单。

  

即在接收到HTTP请求后，分配一个lua协程去处理，但碰到比如反向代理需要等待后端服务器返回数据时，把socket句柄放置的epoll监听队列中，把自己挂起。继续执行其他协程，等到后端服务器返回时，epoll会监听到，然后协程唤醒自己再处理后面的response操作。
也正因此，各个协程之间的数据是隔离的。

Nginx是一个worker就是一个线程，底下是很多的协程。完全基于协程的方式串行处理。



1、功能

使用多级缓存来解决高流量高并发的问题，



访问优化：

第一级 Redis缓存

第二级 热点缓存本地缓存   使用Guava cache组件将热点数据存到JVM本地缓存中。



交易优化：

交易验证优化：

在开始交易后，要针对活动实时信息和用户实时信息进行验证，目的是为了风控策略，检查用户账号是否异常，可以通过异步的方式先将用户模型写入缓存，在缓存中与实时信息做一致性检验，做到风控策略。

在活动开始前半个小时发布活动，对缓存预热，同时后台设计一个紧急下线的接口，清除redis缓存，那么用户下单时就会去数据库查询活动的最新信息了。



交易过程优化：

采用异步消息队列的方式，将异步扣减的消息同步给消息的consumer端，并由消息的consumer端完成数据库扣减的操作，目的是为了削峰。

（1）活动发布同步库存进缓存

（2）下单交易减缓存库存

（3）异步消息扣减数据库内存

我们不追求强一致性，只需要保证最终结果的一致性。比如缓存中的库存和数据库中的库存可能会有不一致情况发生。

加入库存流水状态



解决超卖问题：

设计原则：

宁可少卖，不能超卖

方案：

（1）将库存数据放到Redis里面，在Redis里面做库存预减，Redis中的库存可以比实际数据库少。数据库减库存的时候，先判断库存是否大于0，因为数据库的更新操作是加行锁串行化的(要先加上索引)，所以只需要在减库存的时候判断一下库存是否大于0就可以了。

（2）超时释放（针对消息一直卡死在初始状态，会造成订单大量废弃，设置超时时间）





2、遇到的困难：使用Nginx作为反向代理服务器将后台服务器进行水平扩展之后，可能用户登录之后每次路由请求因为分布式系统导致请求不到一个服务器上，这就可能导致用户每次都需要重新登录，为解决该问题，可以使用 Redis 将用户的 Session 进行集中管理，在这种模式下只要保证 Redis 是高可用和扩展性的，每次用户更新或查询登录信息都直接从 Redis 集中获取。



![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL1NraXJvbllvbmcvc2tpcm9uSW1ncy9pbWcvMjAyMDA3MDQyMzM2MjQucG5n?x-oss-process=image/format,png)



### 项目详细设计

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL1NraXJvbllvbmcvc2tpcm9uSW1ncy9pbWcvMjAyMDA2MDQyMjA4MjgucG5n?x-oss-process=image/format,png)

